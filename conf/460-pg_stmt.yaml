
pg_stmt_94_12:
  name: pg_stmt
  desc: PostgreSQL statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
  # note that postgres user or db and one-time job are not recorded in Monitoring System
  query: |
    SELECT datname,
           queryid                                  AS id,
           sum(calls)                               AS calls,
           sum(rows)                                AS rows,
           sum(total_time)                          AS exec_time,
           sum(blk_read_time) + sum(blk_write_time) AS io_time
    FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid
    WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;

  ttl: 10
  timeout: 1
  min_version: 090400
  max_version: 130000
  tags:
    - cluster
    - extension:pg_stat_statements
    - schema:monitor

  metrics:
    - datname:
        usage: LABEL
        description: Name of database
    - id:
        usage: LABEL
        description: 64 bit query id from internal hash code, computed from the statement's parse tree
    - calls:
        usage: COUNTER
        description: Number of times the statement was executed
    - rows:
        usage: COUNTER
        description: Total number of rows retrieved or affected by the statement
    - exec_time:
        usage: COUNTER
        description: Total time spent executing the statement, in µs
    - io_time:
        usage: COUNTER
        description: Total time the statement spent reading and writing blocks, in µs



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_query.pg_query_13
#┃ PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_query_calls{datname,query}        COUNTER  times been executed
#┃ pg_query_total_time{datname,query}   COUNTER  Total time spent in the statement, in µs
#┃ pg_query_min_time{datname,query}     GAUGE    Minimum time spent in the statement, in µs
#┃ pg_query_max_time{datname,query}     GAUGE    Maximum time spent in the statement, in µs
#┃ pg_query_mean_time{datname,query}    GAUGE    Mean time spent in the statement, in µs
#┃ pg_query_stddev_time{datname,query}  GAUGE    Population standard deviation of time spent in the statement, in µs
#┃ pg_query_rows{datname,query}         COUNTER  rows retrieved or affected by the statement
#┃ pg_query_blk_io_time{datname,query}  COUNTER  time spent reading/writing blocks in µs (if track_io_timing is enabled)
#┃ pg_query_wal_bytes{datname,query}    COUNTER  Total amount of WAL bytes generated by the statement
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_stmt_13:
  name: pg_stmt
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
  query: |
    SELECT datname,
           queryid                                  AS id,
           sum(calls)                               AS calls,
           sum(rows)                                AS rows,
           sum(total_exec_time)                     AS exec_time,
           sum(blk_read_time)                       AS read_time,
           sum(blk_write_time)                      AS write_time,
           sum(blk_read_time) + sum(blk_write_time) AS io_time,
           sum(wal_records)                         AS wal_records,
           sum(wal_fpi)                             AS wal_fpi,
           sum(wal_bytes)                           AS wal_bytes
    FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid
    WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;

  ttl: 10
  timeout: 1
  min_version: 130000
  tags:
    - cluster
    - extension:pg_stat_statements
    - schema:monitor

  metrics:
    - datname:
        usage: LABEL
        description: database name
    - query:
        usage: LABEL
        description: query identifier, bigint
    - calls:
        usage: COUNTER
        description: times been executed
    - total_time:
        usage: COUNTER
        description: Total time spent in the statement, in µs
    - min_time:
        usage: GAUGE
        description: Minimum time spent in the statement, in µs
    - max_time:
        usage: GAUGE
        description: Maximum time spent in the statement, in µs
    - mean_time:
        usage: GAUGE
        description: Mean time spent in the statement, in µs
    - stddev_time:
        usage: GAUGE
        description: Population standard deviation of time spent in the statement, in µs
    - rows:
        usage: COUNTER
        description: rows retrieved or affected by the statement
    - blk_io_time:
        usage: COUNTER
        description: time spent reading/writing blocks in µs (if track_io_timing is enabled)
    - wal_bytes:
        usage: COUNTER
        description: Total amount of WAL bytes generated by the statement

