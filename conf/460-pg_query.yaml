
# OBSOLETE: will be replaced by pg_stmt later
#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_query
#┃ PostgreSQL statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_query_calls{datname,query}        COUNTER  times been executed
#┃ pg_query_total_time{datname,query}   COUNTER  Total time spent in the statement, in µs
#┃ pg_query_min_time{datname,query}     GAUGE    Minimum time spent in the statement, in µs
#┃ pg_query_max_time{datname,query}     GAUGE    Maximum time spent in the statement, in µs
#┃ pg_query_mean_time{datname,query}    GAUGE    Mean time spent in the statement, in µs
#┃ pg_query_stddev_time{datname,query}  GAUGE    Population standard deviation of time spent in the statement, in µs
#┃ pg_query_rows{datname,query}         COUNTER  rows retrieved or affected by the statement
#┃ pg_query_blk_io_time{datname,query}  COUNTER  time spent reading/writing blocks in µs (if track_io_timing is enabled)
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_query:
  name: pg_query
  desc: PostgreSQL statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
  query: |
    SELECT datname, query, calls, total_time, min_time, max_time, mean_time, stddev_time, rows, blk_io_time FROM
      (SELECT dbid,
          queryid               AS query,
          sum(calls)            AS calls,
          sum(total_time)       AS total_time,
          min(min_time)         AS min_time,
          max(max_time)         AS max_time,
          max(mean_time)        AS mean_time,
          max(stddev_time)      AS stddev_time,
          sum(rows)             AS rows,
          sum(blk_read_time) + sum(blk_write_time) AS blk_io_time
      FROM monitor.pg_stat_statements(false) pg_stat_statements(userid, dbid, queryid, query, calls,
          total_time, min_time, max_time, mean_time, stddev_time, rows,
          shared_blks_hit, shared_blks_read, shared_blks_dirtied, shared_blks_written,
          local_blks_hit, local_blks_read, local_blks_dirtied, local_blks_written, temp_blks_read, temp_blks_written,
          blk_read_time, blk_write_time)
      WHERE dbid != 1 AND userid != 10 AND calls > 4
      GROUP BY dbid, queryid ORDER BY total_time DESC LIMIT 64
    ) q NATURAL JOIN (SELECT oid AS dbid, datname FROM pg_database WHERE datname NOT IN ('postgres','template0','template1')) d;

  ttl: 10
  timeout: 1
  min_version: 090400
  max_version: 130000
  tags:
    - cluster
    - extension:pg_stat_statements
    - schema:monitor


  metrics:
    - datname:
        usage: LABEL
        description: database name
    - query:
        usage: LABEL
        description: query identifier, bigint
    - calls:
        usage: COUNTER
        description: times been executed
    - total_time:
        usage: COUNTER
        description: Total time spent in the statement, in µs
    - min_time:
        usage: GAUGE
        description: Minimum time spent in the statement, in µs
    - max_time:
        usage: GAUGE
        description: Maximum time spent in the statement, in µs
    - mean_time:
        usage: GAUGE
        description: Mean time spent in the statement, in µs
    - stddev_time:
        usage: GAUGE
        description: Population standard deviation of time spent in the statement, in µs
    - rows:
        usage: COUNTER
        description: rows retrieved or affected by the statement
    - blk_io_time:
        usage: COUNTER
        description: time spent reading/writing blocks in µs (if track_io_timing is enabled)


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_query.pg_query_13
#┃ PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_query_calls{datname,query}        COUNTER  times been executed
#┃ pg_query_total_time{datname,query}   COUNTER  Total time spent in the statement, in µs
#┃ pg_query_min_time{datname,query}     GAUGE    Minimum time spent in the statement, in µs
#┃ pg_query_max_time{datname,query}     GAUGE    Maximum time spent in the statement, in µs
#┃ pg_query_mean_time{datname,query}    GAUGE    Mean time spent in the statement, in µs
#┃ pg_query_stddev_time{datname,query}  GAUGE    Population standard deviation of time spent in the statement, in µs
#┃ pg_query_rows{datname,query}         COUNTER  rows retrieved or affected by the statement
#┃ pg_query_blk_io_time{datname,query}  COUNTER  time spent reading/writing blocks in µs (if track_io_timing is enabled)
#┃ pg_query_wal_bytes{datname,query}    COUNTER  Total amount of WAL bytes generated by the statement
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_query_13:
  name: pg_query
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
  query: |
    SELECT datname, query, calls, total_time, min_time, max_time, mean_time, stddev_time, rows, blk_io_time, wal_bytes FROM
    (SELECT dbid,
            queryid               AS query,
            sum(calls)            AS calls,
            sum(total_exec_time)  AS total_time,
            min(min_exec_time)    AS min_time,
            max(max_exec_time)    AS max_time,
            max(mean_exec_time)   AS mean_time,
            max(stddev_exec_time) AS stddev_time,
            sum(rows)             AS rows,
            sum(blk_read_time) + sum(blk_write_time) AS blk_io_time,
            sum(wal_bytes)        AS wal_bytes
     FROM monitor.pg_stat_statements(false)
     WHERE dbid != 1 AND userid != 10 AND calls > 4 -- omit postgres db/user and one-time query
     GROUP BY dbid, queryid ORDER BY total_time DESC LIMIT 64
    ) q NATURAL JOIN (SELECT oid AS dbid, datname FROM pg_database WHERE datname NOT IN ('postgres','template0','template1')) d;

  ttl: 10
  timeout: 1
  min_version: 130000
  tags:
    - cluster
    - extension:pg_stat_statements
    - schema:monitor

  metrics:
    - datname:
        usage: LABEL
        description: database name
    - query:
        usage: LABEL
        description: query identifier, bigint
    - calls:
        usage: COUNTER
        description: times been executed
    - total_time:
        usage: COUNTER
        description: Total time spent in the statement, in µs
    - min_time:
        usage: GAUGE
        description: Minimum time spent in the statement, in µs
    - max_time:
        usage: GAUGE
        description: Maximum time spent in the statement, in µs
    - mean_time:
        usage: GAUGE
        description: Mean time spent in the statement, in µs
    - stddev_time:
        usage: GAUGE
        description: Population standard deviation of time spent in the statement, in µs
    - rows:
        usage: COUNTER
        description: rows retrieved or affected by the statement
    - blk_io_time:
        usage: COUNTER
        description: time spent reading/writing blocks in µs (if track_io_timing is enabled)
    - wal_bytes:
        usage: COUNTER
        description: Total amount of WAL bytes generated by the statement

