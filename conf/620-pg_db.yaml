

pg_db_14:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v14 (with 7 more new metrics such as time & session)
  query: |
    SELECT datname,
           numbackends,
           xact_commit,
           xact_rollback,
           xact_rollback + xact_commit              AS xact_total,
           blks_read,
           blks_hit,
           blks_read + blks_hit                     AS blks_access,
           tup_returned,
           tup_fetched,
           tup_inserted,
           tup_updated,
           tup_deleted,
           tup_inserted + tup_updated + tup_deleted AS tup_modified,
           conflicts,
           temp_files,
           temp_bytes,
           deadlocks,
           coalesce(checksum_failures, -1) AS checksum_failures,
           checksum_last_failure,
           blk_read_time,
           blk_write_time,
           session_time,
           active_time,
           idle_in_transaction_time AS ixact_time,
           sessions,
           sessions_abandoned,
           sessions_fatal,
           sessions_killed,
           extract(EPOCH FROM now() - stats_reset)  AS stat_seconds
    FROM pg_stat_database d WHERE datname <> ALL(ARRAY['template0']);

  ttl: 10
  min_version: 140000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - checksum_failures:
        usage: COUNTER
        description: Number of data page checksum failures detected in this database, -1 for not enabled
        # Number of data page checksum failures detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - checksum_last_failure:
        usage: GAUGE
        description: Time at which the last data page checksum failure was detected in this database
        # Time at which the last data page checksum failure was detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - session_time:
        usage: COUNTER
        description: Time spent by database sessions in this database, in ms
        # Time spent by database sessions in this database, in milliseconds (note that statistics are only updated when the state of a session changes, so if sessions have been idle for a long time, this idle time won't be included)
    - active_time:
        usage: COUNTER
        description: Time spent executing SQL statements in this database, in ms
        # Time spent executing SQL statements in this database, in milliseconds (this corresponds to the states active and fastpath function call in pg_stat_activity)
    - ixact_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in milliseconds
    - sessions:
        usage: COUNTER
        description: Total number of sessions established to this database
    - sessions_abandoned:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated because connection to the client was lost
    - sessions_fatal:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated by fatal errors
    - sessions_killed:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated by operator intervention
    - stat_seconds:
        usage: COUNTER
        description: Seconds since last statistic reset












pg_db_12_13:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v12 and v13 (with checksum metrics)
  query: |
    SELECT datname,
           numbackends,
           xact_commit,
           xact_rollback,
           xact_rollback + xact_commit              AS xact_total,
           blks_read,
           blks_hit,
           blks_read + blks_hit                     AS blks_access,
           tup_returned,
           tup_fetched,
           tup_inserted,
           tup_updated,
           tup_deleted,
           tup_inserted + tup_updated + tup_deleted AS tup_modified,
           conflicts,
           temp_files,
           temp_bytes,
           deadlocks,
           coalesce(checksum_failures, -1) AS checksum_failures,
           checksum_last_failure,
           blk_read_time,
           blk_write_time,
           extract(EPOCH FROM now() - stats_reset)  AS stat_seconds
    FROM pg_stat_database d WHERE datname <> ALL(ARRAY['template0']);

  ttl: 10
  min_version: 120000
  max_version: 140000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - checksum_failures:
        usage: COUNTER
        description: Number of data page checksum failures detected in this database, -1 for not enabled
        # Number of data page checksum failures detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - checksum_last_failure:
        usage: GAUGE
        description: Time at which the last data page checksum failure was detected in this database
        # Time at which the last data page checksum failure was detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - stat_seconds:
        usage: COUNTER
        description: Seconds since last statistic reset



pg_db_92_11:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v12 and v13 (with checksum metrics)
  query: |
    SELECT datname,
           numbackends,
           xact_commit,
           xact_rollback,
           xact_rollback + xact_commit              AS xact_total,
           blks_read,
           blks_hit,
           blks_read + blks_hit                     AS blks_access,
           tup_returned,
           tup_fetched,
           tup_inserted,
           tup_updated,
           tup_deleted,
           tup_inserted + tup_updated + tup_deleted AS tup_modified,
           conflicts,
           temp_files,
           temp_bytes,
           deadlocks,
           blk_read_time,
           blk_write_time,
           extract(EPOCH FROM now() - stats_reset)  AS stat_seconds
    FROM pg_stat_database d WHERE datname <> ALL(ARRAY['template0']);

  ttl: 10
  min_version: 90200
  max_version: 120000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - stat_seconds:
        usage: COUNTER
        description: Seconds since last statistic reset

