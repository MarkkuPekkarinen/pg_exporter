
pg_slot_stat:
  name: pg_slot_stat
  desc: PostgreSQL replication slot metrics 10+
  query: |
    SELECT
      slot_name,
      spill_txns,
      spill_count,
      spill_bytes,
      stream_txns,
      stream_count,
      stream_bytes,
      total_txns,
      total_bytes,
      extract(EPOCH FROM now() - stats_reset) AS stat_seconds
    FROM pg_stat_replication_slots;

  ttl: 10
  min_version: 140000
  tags:
    - cluster

  metrics:
    - slot_name:
        usage: LABEL
        description: unique cluster-wide identifier for the replication slot
    - spill_txns:
        usage: COUNTER
        description: Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)
        # Number of transactions spilled to disk once the memory used by logical decoding to decode changes from WAL has exceeded logical_decoding_work_mem. The counter gets incremented for both toplevel transactions and subtransactions.
    - spill_count:
        usage: COUNTER
        description: Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)
        # Number of times transactions were spilled to disk while decoding changes from WAL for this slot. This counter is incremented each time a transaction is spilled, and the same transaction may be spilled multiple times.
    - spill_bytes:
        usage: COUNTER
        description: Bytes that spilled to disk due to logical decode mem exceeding
        # Amount of decoded transaction data spilled to disk while performing decoding of changes from WAL for this slot. This and other spill counters can be used to gauge the I/O which occurred during logical decoding and allow tuning logical_decoding_work_mem.
    - stream_txns:
        usage: COUNTER
        description: Xacts that streamed to decoding output plugin after mem exceed
        # Number of in-progress transactions streamed to the decoding output plugin after the memory used by logical decoding to decode changes from WAL for this slot has exceeded logical_decoding_work_mem. Streaming only works with toplevel transactions (subtransactions can't be streamed independently), so the counter is not incremented for subtransactions.
    - stream_count:
        usage: COUNTER
        description: Xacts that streamed to decoding output plugin after mem exceed  (a xact can be streamed multiple times)
        # Number of times in-progress transactions were streamed to the decoding output plugin while decoding changes from WAL for this slot. This counter is incremented each time a transaction is streamed, and the same transaction may be streamed multiple times.
    - stream_bytes:
        usage: COUNTER
        description: Bytes that streamed to decoding output plugin after mem exceed
        # Amount of transaction data decoded for streaming in-progress transactions to the decoding output plugin while decoding changes from WAL for this slot. This and other streaming counters for this slot can be used to tune logical_decoding_work_mem.
    - total_txns:
        usage: COUNTER
        description: Number of decoded xacts sent to the decoding output plugin for this slot
        # Number of decoded transactions sent to the decoding output plugin for this slot. This counts toplevel transactions only, and is not incremented for subtransactions. Note that this includes the transactions that are streamed and/or spilled.
    - total_bytes:
        usage: COUNTER
        description: Number of decoded bytes sent to the decoding output plugin for this slot
        # Amount of transaction data decoded for sending transactions to the decoding output plugin while decoding changes from WAL for this slot. Note that this includes data that is streamed and/or spilled.
    - stat_seconds:
        usage: COUNTER
        description: Seconds since statistics were last reset
