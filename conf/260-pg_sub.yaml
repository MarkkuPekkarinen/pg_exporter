

pg_sub:
  name: pg_sub
  desc: PostgreSQL subscription statistics
  query: |
    SELECT subid,
           subname,
           received_lsn - '0/0'                      AS recv_lsn,
           latest_end_lsn - '0/0'                    AS lend_lsn,
           extract(epoch from last_msg_send_time)    AS sent_time,
           extract(epoch from last_msg_receipt_time) AS recv_time,
           extract(epoch from latest_end_time)       AS lend_time
    FROM pg_stat_subscription WHERE relid ISNULL LIMIT 1;

  ttl: 10
  tags:
    - cluster
  min_version: 130000

  metrics:
    - subid:
        usage: LABEL
        description: OID of this subscription
    - subname:
        usage: LABEL
        description: Name of this subscription
    - recv_lsn:
        usage: LABEL
        description: location this WAL receiver is connected to
    - sender_port:
        lend_lsn: LABEL
        description: location port number this WAL receiver is connected to
    - sent_time:
        usage: LABEL
        description: Replication slot name used by this WAL receiver
    - lend_time:
        usage: COUNTER
        description: first time received lsn when WAL receiver is started
