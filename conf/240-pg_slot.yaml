

pg_slot_13:
  name: pg_slot
  desc: PostgreSQL replication slot metrics v13+ with wal safe size and status
  query: |
    SELECT slot_name, database AS datname,active,temporary,xmin::TEXT::BIGINT AS xmin,catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
        restart_lsn - '0/0' AS restart_lsn, confirmed_flush_lsn - '0/0' AS confirm_lsn,
        CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes,
        safe_wal_size, CASE wal_status WHEN 'reserved' THEN 0 WHEN 'extended' THEN 1 WHEN 'unreserved' THEN 2 WHEN 'lost' THEN 3 ELSE -1 END AS wal_status
    FROM pg_replication_slots;

    SELECT slot_name,
           database                    AS datname,
           active,
           temporary,
           xmin::TEXT::BIGINT          AS xmin,
           catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
           restart_lsn - '0/0'         AS restart_lsn,
           confirmed_flush_lsn - '0/0' AS confirm_lsn,
           CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes,
           safe_wal_size, CASE wal_status WHEN 'reserved' THEN 0 WHEN 'extended' THEN 1 WHEN 'unreserved' THEN 2 WHEN 'lost' THEN 3 ELSE -1 END AS wal_status
    FROM pg_replication_slots;

  ttl: 10
  min_version: 130000
  tags:
    - cluster
    - primary

  metrics:
    - slot_name:
        usage: LABEL
        description: A unique, cluster-wide identifier for the replication slot
    - datname:
        usage: LABEL
        description: The name of the database this slot is associated with, or null for physical slot.
        # Only logical slots have an associated database.
    - active:
        usage: GAUGE
        description: True(1) if this slot is currently actively being used
    - temporary:
        usage: GAUGE
        description: True(1) if this is a temporary replication slot.
        # Temporary slots are not saved to disk and are automatically dropped on error or when the session has finished.
    - xmin:
        usage: COUNTER
        description: The oldest transaction that this slot needs the database to retain.
        # VACUUM cannot remove tuples deleted by any later transaction.
    - catalog_xmin:
        usage: COUNTER
        description: The oldest transaction affecting the system catalogs that this slot needs the database to retain.
        # VACUUM cannot remove catalog tuples deleted by any later transaction.
    - restart_lsn:
        usage: COUNTER
        description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot
        # The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won't be automatically removed
        # during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.
    - confirm_lsn:
        usage: COUNTER
        description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data.
        # Data older than this is not available anymore. NULL for physical slots.
    - retained_bytes:
        usage: GAUGE
        description: Size of bytes that retained for this slot
    - safe_wal_size:
        usage: GAUGE
        description: bytes that can be written to WAL which will not make slot into lost
    - wal_status:
        usage: GAUGE
        description: WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other


pg_slot_10_12:
  name: pg_slot
  desc: PostgreSQL physicla replication slot metrics v10 v11 v12
  query: |
    SELECT slot_name, database AS datname,active,temporary,xmin::TEXT::BIGINT AS xmin,catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
           restart_lsn - '0/0' AS restart_lsn, confirmed_flush_lsn - '0/0' AS confirm_lsn,
           CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes
    FROM pg_replication_slots;

  ttl: 10
  min_version: 100000
  max_version: 130000
  tags:
    - cluster
    - primary
    # can not create replication slot on replica for now

  metrics:
    - slot_name:
        usage: LABEL
        description: A unique, cluster-wide identifier for the replication slot
    - datname:
        usage: LABEL
        description: The name of the database this slot is associated with, or null for physical slot.
        # Only logical slots have an associated database.
    - active:
        usage: GAUGE
        description: True(1) if this slot is currently actively being used
    - temporary:
        usage: GAUGE
        description: True(1) if this is a temporary replication slot.
        # Temporary slots are not saved to disk and are automatically dropped on error or when the session has finished.
    - xmin:
        usage: COUNTER
        description: The oldest transaction that this slot needs the database to retain.
        # VACUUM cannot remove tuples deleted by any later transaction.
    - catalog_xmin:
        usage: COUNTER
        description: The oldest transaction affecting the system catalogs that this slot needs the database to retain.
        # VACUUM cannot remove catalog tuples deleted by any later transaction.
    - restart_lsn:
        usage: COUNTER
        description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot
        # The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won't be automatically removed
        # during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.
    - confirm_lsn:
        usage: COUNTER
        description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data.
        # Data older than this is not available anymore. NULL for physical slots.
    - retained_bytes:
        usage: GAUGE
        description: Size of bytes that retained for this slot

