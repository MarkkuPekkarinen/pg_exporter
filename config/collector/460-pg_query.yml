##
# SYNOPSIS
#       pg_query.pg_query_13_*
#
# DESCRIPTION
#       PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
#
# OPTIONS
#       Tags       [cluster, schema:monitor, extension:pg_stat_statements]
#       TTL        10
#       Priority   0
#       Timeout    1s
#       Fatal      false
#       Version    130000 ~ higher
#       Source     460-pg_query.yml
#
# METRICS
#       datname (LABEL)
#           Name of database
#       query (LABEL)
#           QueryID generated from internal hash code, computed from the statement's parse tree
#       calls (COUNTER)
#           Number of times the statement was executed
#       rows (COUNTER)
#           Total number of rows retrieved or affected by the statement
#       exec_time (COUNTER)
#           Total time spent executing the statement, in µs
#       io_time (COUNTER)
#           Total time the statement spent reading and writing blocks, in µs
#       wal_bytes (COUNTER)
#           Total amount of WAL bytes generated by the statement
#
pg_query_13:
  name: pg_query
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
  query: |
    SELECT datname, queryid AS query, sum(calls) AS calls, sum(rows) AS rows, sum(total_exec_time) AS exec_time, sum(blk_read_time) + sum(blk_write_time) AS io_time, sum(wal_bytes) AS wal_bytes
      FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;
  ttl: 10
  timeout: 1
  min_version: 130000
  tags:
    - cluster
    - schema:monitor
    - extension:pg_stat_statements

  metrics:
    - datname:
        usage: LABEL
        description: Name of database
    - query:
        usage: LABEL
        description: QueryID generated from internal hash code, computed from the statement's parse tree
    - calls:
        usage: COUNTER
        description: Number of times the statement was executed
    - rows:
        usage: COUNTER
        description: Total number of rows retrieved or affected by the statement
    - exec_time:
        usage: COUNTER
        scale: 1e-3
        description: Total time spent executing the statement, in µs
    - io_time:
        usage: COUNTER
        scale: 1e-3
        description: Total time the statement spent reading and writing blocks, in µs
    - wal_bytes:
        usage: COUNTER
        description: Total amount of WAL bytes generated by the statement

##
# SYNOPSIS
#       pg_query.pg_query_94_12_*
#
# DESCRIPTION
#       PostgreSQL query statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
#
# OPTIONS
#       Tags       [cluster, schema:monitor, extension:pg_stat_statements]
#       TTL        10
#       Priority   0
#       Timeout    1s
#       Fatal      false
#       Version    90400 ~ 130000
#       Source     460-pg_query.yml
#
# METRICS
#       datname (LABEL)
#           Name of database
#       query (LABEL)
#           QueryID generated from internal hash code, computed from the statement's parse tree
#       calls (COUNTER)
#           Number of times the statement was executed
#       rows (COUNTER)
#           Total number of rows retrieved or affected by the statement
#       exec_time (COUNTER)
#           Total time spent executing the statement, in µs
#       io_time (COUNTER)
#           Total time the statement spent reading and writing blocks, in µs
#
pg_query_94_12:
  name: pg_query
  desc: PostgreSQL query statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
  # note that postgres user or db and one-time job are not recorded in Monitoring System
  query: SELECT datname, queryid AS query, sum(calls) AS calls, sum(rows) AS rows, sum(total_time) AS exec_time, sum(blk_read_time) + sum(blk_write_time) AS io_time FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;
  ttl: 10
  timeout: 1
  min_version: 090400
  max_version: 130000
  tags:
    - cluster
    - schema:monitor
    - extension:pg_stat_statements

  metrics:
    - datname:
        usage: LABEL
        description: Name of database
    - query:
        usage: LABEL
        description: QueryID generated from internal hash code, computed from the statement's parse tree
    - calls:
        usage: COUNTER
        description: Number of times the statement was executed
    - rows:
        usage: COUNTER
        description: Total number of rows retrieved or affected by the statement
    - exec_time:
        usage: COUNTER
        scale: 1e-3
        description: Total time spent executing the statement, in µs
    - io_time:
        usage: COUNTER
        scale: 1e-3
        description: Total time the statement spent reading and writing blocks, in µs
